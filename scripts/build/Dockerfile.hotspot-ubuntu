FROM docker.io/library/eclipse-temurin:11-focal
ARG CC=gcc

COPY scripts/ci/apt-install /bin/apt-install
COPY contrib/dependencies/apt-packages.txt /tmp/apt-packages.txt

RUN apt-install \
	bash \
	gdb \
	git \
	iptables \
	maven \
	$(sed 's/\#.*$//' /tmp/apt-packages.txt) \
	&& \
	rm /tmp/apt-packages.txt

COPY . /criu
WORKDIR /criu

RUN make mrproper && make -j $(nproc) CC="$CC"

ENTRYPOINT mvn -q -f test/javaTests/pom.xml test
